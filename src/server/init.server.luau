--[[
	ğŸ® SERVER PRINCIPAL - ARCHITECTURE MODULAIRE REFACTORISÃ‰E

	Ce fichier orchestre tous les modules du jeu.
	Il initialise les services dans le bon ordre et gÃ¨re les dÃ©pendances.

	Architecture:
	â”œâ”€â”€ Config (configuration centralisÃ©e)
	â”œâ”€â”€ Services (RemoteService, GridService, PlayerManager, LightingService)
	â”œâ”€â”€ Modules (EntityFactory, RoomFactory, PathfindingService, WorldManager)
	â”œâ”€â”€ RoundManager (gestion des rounds)
	â””â”€â”€ AdminCommands (commandes admin)
]]

local Players = game:GetService("Players")

print("ğŸš€ === DÃ‰MARRAGE DU SERVEUR - ARCHITECTURE MODULAIRE ===")

-- ============================================================================
-- IMPORTS DES MODULES
-- ============================================================================

-- Configuration
local ServerConfig = require(script.Config.ServerConfig)

-- Services
local RemoteService = require(script.Services.RemoteService)
local GridService = require(script.Services.GridService)
local PlayerManager = require(script.Services.PlayerManager)
local LightingService = require(script.Services.LightingService)

-- Modules
local EntityFactory = require(script.Modules.EntityFactory)
local RoomFactory = require(script.Modules.RoomFactory)
local PathfindingService = require(script.Modules.PathfindingService)
local WorldManager = require(script.Modules.WorldManager)

-- SystÃ¨mes
local RoundManager = require(script.RoundManager)
local AdminCommands = require(script.AdminCommands)

-- ============================================================================
-- INITIALISATION DES SERVICES (ORDRE IMPORTANT)
-- ============================================================================

print("ğŸ”§ Initialisation des services...")

-- 1. Services de base
local remoteService = RemoteService:Init()
local gridService = GridService:Init()
local playerManager = PlayerManager:Init()
LightingService:Init() -- Pas besoin de stocker, juste initialiser

-- 2. Modules de fabrication
local entityFactory = EntityFactory:Init(remoteService, playerManager)
local roomFactory = RoomFactory:Init(gridService, entityFactory)
local pathfindingService = PathfindingService:Init(gridService)

-- 3. WorldManager (orchestrateur principal)
local worldManager = WorldManager:Init({
	gridService = gridService,
	remoteService = remoteService,
	playerManager = playerManager,
	roomFactory = roomFactory,
	pathfindingService = pathfindingService,
})

-- 4. RoundManager
local roundManager = RoundManager:Init(worldManager, remoteService, playerManager)

-- 5. AdminCommands (charger toutes les commandes)
AdminCommands.init()

print("âœ… Tous les services initialisÃ©s")

-- ============================================================================
-- GESTION DES JOUEURS
-- ============================================================================

-- Quand un joueur rejoint
Players.PlayerAdded:Connect(function(player)
	-- VÃ©rifier si c'est un admin
	if AdminCommands.isAdmin(player) then
		print("ğŸ‘‘ ADMIN connectÃ©:", player.Name)
		task.wait(2)
		player:SetAttribute("IsAdmin", true)
	end

	-- Ã‰couter les commandes dans le chat
	player.Chatted:Connect(function(message)
		if message:sub(1, 1) == "/" then
			print("ğŸ’¬", player.Name, ":", message)

			-- RÃ©cupÃ©rer le gameState pour les commandes admin
			local gameState = worldManager:GetGameState()

			local success, result = AdminCommands.executeCommand(player, message, gameState)
			if success then
				print("âœ…", result)
			else
				print("âŒ", result)
				warn(player.Name .. " - " .. result)
			end
		end
	end)

	-- Quand le personnage spawn
	player.CharacterAdded:Connect(function(_character)
		task.wait(1) -- Attendre que le personnage soit complÃ¨tement chargÃ©

		-- TÃ©lÃ©porter au spawn si on est en round
		if roundManager.currentState == RoundManager.States.PLAYING then
			worldManager:TeleportPlayerToRoom(
				player,
				gridService.startPos.x,
				gridService.startPos.y
			)
		end
	end)
end)

-- Quand un joueur part
Players.PlayerRemoving:Connect(function(player)
	gridService:RemovePlayerPosition(player.UserId)
end)

-- ============================================================================
-- DÃ‰TECTION DE FIN DE PARTIE
-- ============================================================================

-- Hook la dÃ©tection de fin de partie dans le WorldManager
print("ğŸ”— Installation du hook EndGame...")
worldManager.EndGame = function(_self, winner)
	print("ğŸ¯ Hook EndGame appelÃ©! Winner:", winner and winner.Name or "nil")
	print("ğŸ¯ Redirection vers RoundManager:EndRound...")
	-- Terminer le round via RoundManager
	roundManager:EndRound(winner)
end
print("âœ… Hook EndGame installÃ©")

-- Hook pour redÃ©marrer complÃ¨tement le jeu
print("ğŸ”— Installation du hook RestartGame...")
local function restartGameCompletely()
	print("ğŸ”„ === REDÃ‰MARRAGE COMPLET DU JEU ===")

	-- 1. Forcer l'Ã©tat du round Ã  WAITING pour arrÃªter tout
	roundManager.currentState = RoundManager.States.WAITING
	print("âœ… Round arrÃªtÃ©")

	-- 2. Reset le monde (dÃ©truit toutes les salles, reset les positions)
	worldManager:ResetWorld()
	print("âœ… Monde rÃ©initialisÃ©")

	-- 3. Notifier tous les clients
	remoteService:FireAllClients("RoundStateChanged", "WAITING", 3)
	print("âœ… Clients notifiÃ©s")

	-- 4. Attendre un peu pour que les joueurs voient le message
	task.wait(3)

	-- 5. DÃ©marrer un nouveau round immÃ©diatement
	roundManager:StartNewRound()
	print("âœ… Nouveau round dÃ©marrÃ©")

	print("ğŸ‰ === REDÃ‰MARRAGE TERMINÃ‰ ===")
end

-- Installer le hook dans worldManager
worldManager.restartGame = restartGameCompletely
print("âœ… Hook RestartGame installÃ©")

-- ============================================================================
-- DÃ‰MARRAGE DU JEU
-- ============================================================================

print("âœ… === SERVEUR PRÃŠT ===")
print("ğŸ® SystÃ¨me de rounds actif!")
print("ğŸ—ºï¸ Monde partagÃ© persistant - Grille " .. ServerConfig.Grid.SIZE .. "x" .. ServerConfig.Grid.SIZE)
print("ğŸ‘‘ Admins configurÃ©s:", #AdminCommands.ADMINS or 0)
print("")

-- DÃ©marrer le systÃ¨me de rounds
roundManager:Start()

print("ğŸ¯ Le jeu a dÃ©marrÃ©!")
