--[[
	Client du jeu - Point d'entr√©e principal
	Architecture modulaire professionnelle

	Structure:
	- controllers/ : Logique m√©tier (gestion des √©v√©nements)
	- ui/          : Interfaces utilisateur (affichage)
	- effects/     : Effets visuels (animations, cam√©ra)
]]

local Players = game:GetService("Players")

local player = Players.LocalPlayer

print("üöÄ === D√âMARRAGE DU CLIENT ===")

-- ============================================================================
-- CHARGEMENT DES MODULES
-- ============================================================================

-- Gestionnaires
local SoundManager = require(script:WaitForChild("SoundManager", 10))

-- Attendre que les dossiers soient charg√©s (avec timeout de 10 secondes)
local effectsFolder = script:WaitForChild("effects", 10)
local uiFolder = script:WaitForChild("ui", 10)
local controllersFolder = script:WaitForChild("Controllers", 10)

if not effectsFolder then
	error("‚ùå Dossier 'effects' introuvable!")
end
if not uiFolder then
	error("‚ùå Dossier 'ui' introuvable!")
end
if not controllersFolder then
	error("‚ùå Dossier 'controllers' introuvable!")
end

-- Effets visuels
local CollectEffects = require(effectsFolder:WaitForChild("CollectEffects"))
local CameraEffects = require(effectsFolder:WaitForChild("CameraEffects"))

-- Interfaces utilisateur
local ScoreUI = require(uiFolder:WaitForChild("ScoreUI"))
local RoundUI = require(uiFolder:WaitForChild("RoundUI"))
local EndScreenUI = require(uiFolder:WaitForChild("EndScreenUI"))
local TimerUI = require(uiFolder:WaitForChild("TimerUI"))
local CompassUI = require(uiFolder:WaitForChild("CompassUI"))
local AdminUI = require(uiFolder:WaitForChild("AdminUI"))

-- Contr√¥leurs (logique)
local CoinController = require(controllersFolder:WaitForChild("CoinController"))
local RoundController = require(controllersFolder:WaitForChild("RoundController"))
local DoorController = require(controllersFolder:WaitForChild("DoorController"))
local CompassController = require(controllersFolder:WaitForChild("CompassController"))

print("‚úÖ Modules charg√©s")

-- ============================================================================
-- INITIALISATION DES INTERFACES
-- ============================================================================

-- Cr√©er les interfaces utilisateur
ScoreUI.create()
RoundUI.create()

print("‚úÖ Interfaces cr√©√©es")

-- ============================================================================
-- INITIALISATION DES CONTR√îLEURS
-- ============================================================================

-- Injecter les d√©pendances dans les contr√¥leurs
CoinController.initialize({
	SoundManager = SoundManager,
	CollectEffects = CollectEffects,
	CameraEffects = CameraEffects
})

RoundController.initialize({
	SoundManager = SoundManager,
	RoundUI = RoundUI,
	EndScreenUI = EndScreenUI,
	TimerUI = TimerUI
})

DoorController.initialize({
	SoundManager = SoundManager
})

CompassController.initialize({
	CompassUI = CompassUI
})

print("‚úÖ Contr√¥leurs initialis√©s")

-- ============================================================================
-- CONNEXION AUX √âV√âNEMENTS SERVEUR
-- ============================================================================

-- Connecter tous les contr√¥leurs aux √©v√©nements
CoinController.connect()
RoundController.connect()
DoorController.connect()
CompassController.connect()

print("‚úÖ √âv√©nements connect√©s")

-- ============================================================================
-- √âCOUTE DU SCORE (LEADERSTATS)
-- ============================================================================

local leaderstats = player:WaitForChild("leaderstats", 10)
if leaderstats then
	local coins = leaderstats:WaitForChild("Coins", 5)

	if coins then
		-- Mise √† jour du score quand il change
		coins.Changed:Connect(function()
			ScoreUI.update(coins.Value)
		end)

		-- Mise √† jour initiale
		ScoreUI.update(coins.Value)
		print("‚úÖ Score initialis√©:", coins.Value)
	end
end

-- ============================================================================
-- INTERFACE ADMIN (SI APPLICABLE)
-- ============================================================================

task.spawn(function()
	task.wait(3) -- Attendre que l'attribut soit d√©fini

	if player:GetAttribute("IsAdmin") then
		print("üëë Mode admin activ√©")
		AdminUI.create()
	end
end)

-- ============================================================================
-- CLIENT PR√äT
-- ============================================================================

print("‚úÖ === CLIENT PR√äT ===")
print("üéÆ Pr√™t √† jouer!")
